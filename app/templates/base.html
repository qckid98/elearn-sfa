<!DOCTYPE html>
<html lang="id">

<head>
  <!-- Apply theme IMMEDIATELY to prevent flash -->
  <script>
    (function () {
      var theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Sparks Fashion Academy System{% endblock %}</title>
  <link rel="icon" href="{{ url_for('static', filename='img/sfa-logo.png') }}">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Bootstrap (minimal usage) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Custom Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />

  {% block extra_css %}{% endblock %}

  <!-- Inline Dark Mode CSS - Critical for immediate rendering -->
  <style>
    [data-theme="dark"] {
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-color: #334155;
      --sidebar-bg: #1e293b;
      --sidebar-bg-dark: #0f172a;
      --sidebar-text: #94a3b8;
      --sidebar-hover: rgba(255, 255, 255, 0.08);
      --sidebar-active: rgba(220, 53, 69, 0.3);
    }

    [data-theme="dark"] body {
      background-color: var(--bg-body);
      color: var(--text-primary);
    }

    [data-theme="dark"] .sidebar {
      background: linear-gradient(180deg, var(--sidebar-bg) 0%, var(--sidebar-bg-dark) 100%);
      border-right: 1px solid var(--border-color);
    }

    [data-theme="dark"] .top-header {
      background: var(--bg-card);
      border-bottom-color: var(--border-color);
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .stats-card,
    [data-theme="dark"] .action-card {
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .card-title,
    [data-theme="dark"] .stats-card-value,
    [data-theme="dark"] .header-user-name {
      color: var(--text-primary);
    }

    [data-theme="dark"] .page-title {
      color: var(--text-primary);
    }

    [data-theme="dark"] .content-body {
      background: var(--bg-body);
    }

    [data-theme="dark"] .form-control {
      background: var(--bg-body);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .table {
      color: var(--text-primary);
    }

    [data-theme="dark"] .table thead th {
      background: var(--bg-body);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .table tbody td {
      border-color: var(--border-color);
    }

    [data-theme="dark"] .modal-content {
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .dropdown-menu {
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .dropdown-item {
      color: var(--text-primary);
    }

    [data-theme="dark"] .dropdown-item:hover {
      background: var(--bg-body);
    }

    [data-theme="dark"] .btn-close {
      filter: invert(1);
    }

    [data-theme="dark"] .header-icon-btn {
      background: var(--bg-body);
      color: var(--text-secondary);
    }

    [data-theme="dark"] .sidebar-logo {
      background: var(--bg-body);
    }

    [data-theme="dark"] .nav-tabs .nav-link.active {
      background: var(--bg-card);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .list-group-item {
      background: var(--bg-card);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .accordion-button {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    [data-theme="dark"] .alert {
      background: var(--bg-card);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .bg-white {
      background-color: var(--bg-card) !important;
    }

    [data-theme="dark"] .bg-light {
      background-color: var(--bg-body) !important;
    }

    [data-theme="dark"] .text-dark {
      color: var(--text-primary) !important;
    }

    /* Table cells background */
    [data-theme="dark"] .table tbody tr,
    [data-theme="dark"] .table tbody td {
      background-color: var(--bg-card);
    }

    /* Featured/Stats cards with colored backgrounds - ensure text is visible */
    [data-theme="dark"] .featured-card,
    [data-theme="dark"] .stats-card.bg-danger,
    [data-theme="dark"] .stats-card.bg-success,
    [data-theme="dark"] .stats-card.bg-warning,
    [data-theme="dark"] .stats-card.bg-info,
    [data-theme="dark"] .stats-card.bg-primary {
      color: #ffffff;
    }

    [data-theme="dark"] .featured-card .stats-card-label,
    [data-theme="dark"] .stats-card .stats-card-label {
      color: rgba(255, 255, 255, 0.85);
    }

    /* Schedule grid/master schedule specific */
    [data-theme="dark"] .schedule-cell,
    [data-theme="dark"] .schedule-grid td,
    [data-theme="dark"] [class*="schedule"] td {
      background-color: var(--bg-card);
      border-color: var(--border-color);
    }

    /* Legend items */
    [data-theme="dark"] .legend-item,
    [data-theme="dark"] .badge-legend {
      color: var(--text-primary);
    }

    /* Card body backgrounds */
    [data-theme="dark"] .card-body {
      background-color: var(--bg-card);
    }

    /* Form select */
    [data-theme="dark"] .form-select {
      background-color: var(--bg-body);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    /* Input groups */
    [data-theme="dark"] .input-group-text {
      background-color: var(--bg-body);
      border-color: var(--border-color);
      color: var(--text-secondary);
    }

    /* Breadcrumbs */
    [data-theme="dark"] .breadcrumb {
      background-color: transparent;
    }

    [data-theme="dark"] .breadcrumb-item a {
      color: var(--text-secondary);
    }

    /* Pagination */
    [data-theme="dark"] .page-link {
      background-color: var(--bg-card);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .page-item.active .page-link {
      background-color: var(--brand-primary, #dc3545);
      border-color: var(--brand-primary, #dc3545);
    }

    /* Any remaining white backgrounds */
    [data-theme="dark"] [style*="background: white"],
    [data-theme="dark"] [style*="background-color: white"],
    [data-theme="dark"] [style*="background:#fff"],
    [data-theme="dark"] [style*="background-color:#fff"] {
      background-color: var(--bg-card) !important;
    }

    /* Schedule stats (Total Siswa, Total Jadwal cards) */
    [data-theme="dark"] .schedule-stat {
      background: var(--bg-card) !important;
      border-color: var(--border-color) !important;
    }

    [data-theme="dark"] .schedule-stat-label {
      color: var(--text-secondary);
    }

    /* Schedule cells and grid */
    [data-theme="dark"] .schedule-cell,
    [data-theme="dark"] .slot-cell {
      background-color: var(--bg-card);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .header-row-title {
      background: var(--bg-body) !important;
      border-color: var(--border-color) !important;
    }

    /* Density backgrounds for dark mode */
    [data-theme="dark"] .density-empty {
      background: var(--bg-card) !important;
    }

    [data-theme="dark"] .density-low {
      background: rgba(16, 185, 129, 0.15) !important;
    }

    [data-theme="dark"] .density-medium {
      background: rgba(245, 158, 11, 0.15) !important;
    }

    [data-theme="dark"] .density-high {
      background: rgba(220, 53, 69, 0.15) !important;
    }

    /* Student cards inside schedule */
    [data-theme="dark"] .student-card {
      background: var(--bg-body) !important;
      border-color: var(--border-color) !important;
    }

    [data-theme="dark"] .student-card .student-name {
      color: var(--text-primary) !important;
    }

    [data-theme="dark"] .student-card .student-details {
      border-color: var(--border-color);
    }

    /* Legend items */
    [data-theme="dark"] .legend-bar {
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .legend-dot.empty {
      background: var(--bg-body) !important;
      border-color: var(--border-color) !important;
    }

    /* Student count badge */
    [data-theme="dark"] .student-count {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
    }
  </style>
</head>

<body>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
  <div class="toast-wrapper">
    {% for message in messages %}
    <div class="alert alert-info">
      <i class="fas fa-info-circle"></i>
      <span>{{ message }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  {% if current_user.is_authenticated %}
  <!-- App Layout with Sidebar -->
  <div class="app-wrapper">
    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Sidebar Header -->
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="{{ url_for('static', filename='img/sfa-logo.png') }}" alt="SFA Logo"
            style="width: 24px; height: auto;">
        </div>
        <div class="sidebar-brand">
          <span class="sidebar-brand-name">SPARKS<span style="opacity: 0.7">FASHION</span></span>
          <span class="sidebar-brand-tagline">Academy System</span>
        </div>
        <button class="sidebar-toggle" title="Toggle Sidebar">
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>

      <!-- Sidebar Navigation -->
      <nav class="sidebar-nav">
        <!-- Main Menu -->
        <div class="nav-section">
          <a href="{{ url_for('main.dashboard') }}"
            class="nav-item {% if request.endpoint == 'main.dashboard' %}active{% endif %}">
            <i class="fas fa-th-large"></i>
            <span>Dashboard</span>
          </a>
        </div>

        {% if current_user.role == 'admin' %}
        <!-- Admin Menu -->
        <div class="nav-section">
          <div class="nav-section-title">Manajemen</div>
          <a href="{{ url_for('main.admin_invite') }}"
            class="nav-item {% if request.endpoint == 'main.admin_invite' %}active{% endif %}">
            <i class="fas fa-user-plus"></i>
            <span>Invite Siswa</span>
          </a>
          <a href="{{ url_for('admin.student_list') }}"
            class="nav-item {% if 'student' in request.endpoint %}active{% endif %}">
            <i class="fas fa-users"></i>
            <span>Data Siswa</span>
          </a>
          <a href="{{ url_for('admin.teacher_list') }}"
            class="nav-item {% if 'teacher' in request.endpoint %}active{% endif %}">
            <i class="fas fa-chalkboard-teacher"></i>
            <span>Pengajar</span>
          </a>
          <a href="{{ url_for('admin.program_manage') }}"
            class="nav-item {% if 'program' in request.endpoint %}active{% endif %}">
            <i class="fas fa-book-open"></i>
            <span>Program</span>
          </a>
          <a href="{{ url_for('admin.master_class_list') }}"
            class="nav-item {% if 'master_class' in request.endpoint %}active{% endif %}">
            <i class="fas fa-graduation-cap"></i>
            <span>Master Kelas</span>
          </a>
          <a href="{{ url_for('admin.master_schedule') }}"
            class="nav-item {% if 'schedule' in request.endpoint %}active{% endif %}">
            <i class="fas fa-calendar-alt"></i>
            <span>Master Schedule</span>
          </a>
          <a href="{{ url_for('admin.teacher_recap') }}"
            class="nav-item {% if 'recap' in request.endpoint %}active{% endif %}">
            <i class="fas fa-file-invoice"></i>
            <span>Rekap Pengajar</span>
          </a>
          <a href="{{ url_for('admin.tools_list') }}"
            class="nav-item {% if 'tools' in request.endpoint %}active{% endif %}">
            <i class="fas fa-tools"></i>
            <span>Data Tools</span>
          </a>
          <a href="{{ url_for('admin_syllabus.index') }}"
            class="nav-item {% if 'syllabus' in request.endpoint %}active{% endif %}">
            <i class="fas fa-book"></i>
            <span>Silabus</span>
          </a>
        </div>

        {% elif current_user.role == 'teacher' %}
        <!-- Teacher Menu -->
        <div class="nav-section">
          <div class="nav-section-title">Mengajar</div>
          <a href="{{ url_for('teacher.student_list') }}"
            class="nav-item {% if 'teacher.student' in request.endpoint %}active{% endif %}">
            <i class="fas fa-users"></i>
            <span>Siswa Saya</span>
          </a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Absensi</div>
          <a href="{{ url_for('attendance.view_form', timeslot_id=1) }}" class="nav-item">
            <i class="fas fa-sun"></i>
            <span>Sesi 1 (Pagi)</span>
          </a>
          <a href="{{ url_for('attendance.view_form', timeslot_id=2) }}" class="nav-item">
            <i class="fas fa-cloud-sun"></i>
            <span>Sesi 2 (Siang)</span>
          </a>
          <a href="{{ url_for('attendance.view_form', timeslot_id=3) }}" class="nav-item">
            <i class="fas fa-moon"></i>
            <span>Sesi 3 (Malam)</span>
          </a>
        </div>

        {% else %}
        <!-- Student Menu -->
        <div class="nav-section">
          <div class="nav-section-title">Akademik</div>
          <a href="{{ url_for('onboarding.schedule_wizard') }}" class="nav-item">
            <i class="fas fa-calendar-check"></i>
            <span>Atur Jadwal</span>
          </a>
          <a href="{{ url_for('portfolio.index') }}"
            class="nav-item {% if 'portfolio' in request.endpoint %}active{% endif %}">
            <i class="fas fa-folder-open"></i>
            <span>Portfolio</span>
          </a>
        </div>
        {% endif %}
      </nav>

      <!-- Sidebar Footer -->
      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-user-avatar">
            {{ current_user.name[0]|upper if current_user.name else '?' }}
          </div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name">{{ current_user.name if current_user.name else 'User' }}</div>
            <div class="sidebar-user-role">{{ current_user.role|capitalize }}</div>
          </div>
          <a href="{{ url_for('auth.logout') }}" class="sidebar-user-logout" title="Logout">
            <i class="fas fa-sign-out-alt"></i>
          </a>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Header -->
      <header class="top-header">
        <div class="header-left">
          <button class="btn btn-icon mobile-toggle">
            <i class="fas fa-bars"></i>
          </button>

          <!-- Server Time Clock -->
          <div class="d-none d-sm-flex align-items-center gap-2 text-muted fw-600 ms-3" style="font-size: 14px;">
            <i class="fas fa-clock text-brand-primary"></i>
            <span id="serverClock">{{ now.strftime('%H:%M:%S') }}</span> WIB
          </div>

          <h1 class="page-title ms-4">{% block page_title %}Dashboard{% endblock %}</h1>
        </div>
        <div class="header-right">
          <button class="header-icon-btn" title="Tema" data-theme-toggle>
            <i class="fas fa-moon"></i>
          </button>
          <button class="header-icon-btn" title="Notifikasi">
            <i class="fas fa-bell"></i>
          </button>
          <div class="dropdown">
            <div class="header-user" data-dropdown-toggle>
              <div class="header-user-info">
                <div class="header-user-name">{{ current_user.name if current_user.name else 'User' }}</div>
                <div class="header-user-date">{{ now.strftime('%d %b %Y') }}</div>
              </div>
            </div>
            <div class="dropdown-menu">
              <div class="dropdown-item">
                <i class="fas fa-user"></i>
                <span>Profil Saya</span>
              </div>
              <div class="dropdown-item">
                <i class="fas fa-cog"></i>
                <span>Pengaturan</span>
              </div>
              <div class="dropdown-divider"></div>
              <a href="{{ url_for('auth.logout') }}" class="dropdown-item danger">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </a>
            </div>
          </div>
        </div>
      </header>

      <!-- Content Body -->
      <div class="content-body">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  {% else %}
  <!-- Guest Layout (Login, etc.) -->
  <div class="guest-wrapper">
    {% block guest_content %}{% endblock %}
  </div>
  {% endif %}

  <!-- Core JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{{ url_for('static', filename='js/app.js') }}"></script>

  <script>
    // Server Clock Script
    // Initialize with server time via Jinja
    let serverTime = new Date("{{ now.strftime('%Y-%m-%dT%H:%M:%S') }}");

    function updateClock() {
      serverTime.setSeconds(serverTime.getSeconds() + 1);

      const hours = String(serverTime.getHours()).padStart(2, '0');
      const minutes = String(serverTime.getMinutes()).padStart(2, '0');
      const seconds = String(serverTime.getSeconds()).padStart(2, '0');

      const clockEl = document.getElementById('serverClock');
      if (clockEl) {
        clockEl.textContent = `${hours}:${minutes}:${seconds}`;
      }
    }

    setInterval(updateClock, 1000);
  </script>

  <!-- Dark Mode Script - Inline for reliability -->
  <script>
    (function () {
      // Theme toggle functionality
      const themeBtn = document.querySelector('[data-theme-toggle]');

      function getTheme() {
        return localStorage.getItem('theme') || 'light';
      }

      function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);

        // Update icon
        if (themeBtn) {
          const icon = themeBtn.querySelector('i');
          if (icon) {
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
          }
        }
      }

      // Initialize theme on page load
      setTheme(getTheme());

      // Toggle on button click
      if (themeBtn) {
        themeBtn.addEventListener('click', function (e) {
          e.preventDefault();
          const newTheme = getTheme() === 'dark' ? 'light' : 'dark';
          setTheme(newTheme);
        });
      }
    })();
  </script>

  {% block extra_js %}{% endblock %}
</body>

</html>