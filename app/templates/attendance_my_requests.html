{% extends "base.html" %}

{% block page_title %}Riwayat Request Absen{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-700 mb-1">Riwayat Request Absen</h4>
        <p class="text-muted mb-0">Daftar request absen yang telah Anda ajukan</p>
    </div>
    <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i> Kembali
    </a>
</div>

{% if grouped_sessions %}
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-modern mb-0">
                <thead>
                    <tr>
                        <th>Tanggal Sesi</th>
                        <th>Sesi</th>
                        <th>Kelas</th>
                        <th>Siswa</th>
                        <th>Status</th>
                        <th>Tanggal Request</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in grouped_sessions %}
                    <tr>
                        <td>
                            <div class="fw-600">{{ session.date.strftime('%d %b %Y') }}</div>
                            <small class="text-muted">
                                {% set days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'] %}
                                {{ days[session.date.weekday()] }}
                            </small>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ session.timeslot.name if session.timeslot else '-'
                                }}</span>
                        </td>
                        <td>{{ session.class_name }}</td>
                        <td>
                            <span class="badge bg-info">{{ session.student_count }} siswa</span>
                        </td>
                        <td>
                            {% if session.overall_status == 'pending' %}
                            <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Pending ({{
                                session.pending_count }})</span>
                            {% elif session.overall_status == 'approved' %}
                            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Approved ({{
                                session.approved_count }})</span>
                            {% else %}
                            <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Rejected ({{
                                session.rejected_count }})</span>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ session.request_date.strftime('%d %b %Y') }}</small>
                        </td>
                    </tr>
                    <!-- Detail Row (collapsible) -->
                    <tr class="bg-light">
                        <td colspan="6" style="padding: 12px 24px;">
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                {% for req in session.requests %}
                                <div class="d-inline-flex align-items-center gap-2 px-3 py-2 rounded"
                                    style="background: {% if req.approval_status == 'approved' %}rgba(40, 167, 69, 0.1){% elif req.approval_status == 'rejected' %}rgba(220, 53, 69, 0.1){% else %}rgba(255, 193, 7, 0.1){% endif %};">
                                    <span class="fw-500">{{ req.booking.enrollment.student.name }}</span>
                                    <span
                                        class="badge {% if req.status_request == 'Hadir' %}bg-success{% elif req.status_request == 'Izin' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                        {{ req.status_request }}
                                    </span>
                                    {% if req.approval_status == 'approved' %}
                                    <i class="fas fa-check-circle text-success"></i>
                                    {% elif req.approval_status == 'rejected' %}
                                    <i class="fas fa-times-circle text-danger" title="{{ req.rejection_reason }}"></i>
                                    {% else %}
                                    <i class="fas fa-clock text-warning"></i>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            <small class="text-muted"><i class="fas fa-comment me-1"></i>Alasan: {{ session.reason[:100]
                                }}{% if session.reason|length > 100 %}...{% endif %}</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<!-- Empty State -->
<div class="card">
    <div class="card-body text-center py-5">
        <div class="avatar avatar-xl mx-auto mb-3" style="background: var(--secondary); color: white;">
            <i class="fas fa-inbox"></i>
        </div>
        <h5 class="fw-600 mb-2">Belum Ada Request</h5>
        <p class="text-muted mb-0">Anda belum pernah mengajukan request absen.</p>
    </div>
</div>
{% endif %}
{% endblock %}