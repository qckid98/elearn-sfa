{% extends "base.html" %}

{% block page_title %}Request Absen Sesi{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-700 mb-1">Request Absen Lewat</h4>
        <p class="text-muted mb-0">
            {{ timeslot.name }} â€¢ {{ booking_date.strftime('%d %B %Y') }}
        </p>
    </div>
    <a href="{{ url_for('attendance.pending_bookings') }}" class="btn btn-secondary btn-icon"
        style="width: 40px; height: 40px;">
        <i class="fas fa-times"></i>
    </a>
</div>

<!-- Alert: Alasan Wajib -->
<div class="alert"
    style="background: rgba(220, 53, 69, 0.1); border: 1px solid var(--danger); border-radius: var(--radius-lg); padding: 16px; margin-bottom: 20px;">
    <div class="d-flex align-items-start gap-3">
        <i class="fas fa-exclamation-triangle text-danger" style="font-size: 20px; margin-top: 2px;"></i>
        <div>
            <h6 class="fw-600 mb-1 text-danger">Sesi Sudah Lewat</h6>
            <p class="text-muted mb-0" style="font-size: 13px;">
                Anda lupa mengisi absensi untuk sesi ini. Isi form di bawah dan berikan alasan yang jelas.
                Request akan ditinjau oleh admin.
            </p>
        </div>
    </div>
</div>

<form method="POST"
    action="{{ url_for('attendance.request_late_session', date_str=booking_date.strftime('%Y-%m-%d'), timeslot_id=timeslot.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

    <!-- Alasan Lupa Absen -->
    <div class="card mb-4" style="border-left: 4px solid var(--danger);">
        <div class="card-header">
            <h6 class="fw-600 mb-0"><i class="fas fa-question-circle text-danger me-2"></i>Alasan Lupa Absen</h6>
        </div>
        <div class="card-body">
            <textarea name="reason" class="form-control" rows="3" minlength="20" required
                placeholder="Jelaskan mengapa Anda tidak mengisi absensi tepat waktu (minimal 20 karakter)..."></textarea>
            <small class="text-muted">Alasan ini akan ditinjau oleh admin.</small>
        </div>
    </div>

    <!-- Daftar Siswa -->
    <div class="mb-4">
        <h6 class="fw-600 text-muted mb-3"><i class="fas fa-users me-2"></i>Absensi Siswa ({{ bookings|length }} siswa)
        </h6>
        <div class="row g-3">
            {% for booking in bookings %}
            <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <!-- Student Info -->
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <div class="avatar">
                                {{ booking.enrollment.student.name[0] }}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-600 mb-1">{{ booking.enrollment.student.name }}</h6>
                                <div class="text-muted" style="font-size: 12px;">
                                    {{ booking.enrollment.program.name }}
                                </div>
                            </div>
                        </div>

                        <!-- Status Selection -->
                        <div class="mb-3">
                            <label class="form-label fw-500">Status Kehadiran</label>
                            <div class="d-flex gap-2 flex-wrap">
                                <input type="radio" class="btn-check" name="status_{{ booking.id }}"
                                    id="hadir_{{ booking.id }}" value="Hadir" checked>
                                <label class="btn btn-outline-success btn-sm" for="hadir_{{ booking.id }}">
                                    <i class="fas fa-check me-1"></i>Hadir
                                </label>

                                <input type="radio" class="btn-check" name="status_{{ booking.id }}"
                                    id="izin_{{ booking.id }}" value="Izin">
                                <label class="btn btn-outline-warning btn-sm" for="izin_{{ booking.id }}">
                                    <i class="fas fa-hand-paper me-1"></i>Izin
                                </label>

                                <input type="radio" class="btn-check" name="status_{{ booking.id }}"
                                    id="alpha_{{ booking.id }}" value="Alpha">
                                <label class="btn btn-outline-danger btn-sm" for="alpha_{{ booking.id }}">
                                    <i class="fas fa-times me-1"></i>Alpha
                                </label>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div>
                            <label class="form-label fw-500">Catatan (opsional)</label>
                            <input type="text" name="notes_{{ booking.id }}" class="form-control form-control-sm"
                                placeholder="Catatan untuk siswa ini...">
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Submit Button - Fixed Bottom (respects sidebar) -->
    <div class="fixed-bottom bg-white py-3 px-4 border-top shadow-lg" style="z-index: 1000; left: 260px;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="fw-600">{{ bookings|length }} siswa</span>
                <span class="text-muted">akan di-request</span>
            </div>
            <button type="submit" class="btn btn-danger btn-lg">
                <i class="fas fa-paper-plane me-2"></i>Kirim Request
            </button>
        </div>
    </div>

    <!-- Spacer untuk fixed bottom -->
    <div style="height: 100px;"></div>
</form>
{% endblock %}