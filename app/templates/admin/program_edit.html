{% extends "base.html" %}

{% block page_title %}Edit Program{% endblock %}

{% block content %}
<div class="row g-4">
  <!-- Left Column - Program Info -->
  <div class="col-lg-5">
    <!-- Breadcrumb -->
    <div class="d-flex align-items-center gap-3 mb-4">
      <a href="{{ url_for('admin.program_manage') }}" class="btn btn-secondary btn-icon"
        style="width: 40px; height: 40px;">
        <i class="fas fa-arrow-left"></i>
      </a>
      <div>
        <h4 class="fw-700 mb-1">Edit Program</h4>
        <p class="text-muted mb-0" style="font-size: 13px;">{{ program.name }}</p>
      </div>
    </div>

    <!-- Program Info Card -->
    <div class="card" style="border-top: 4px solid var(--warning);">
      <div class="card-body p-4">
        <form method="POST">
          <input type="hidden" name="update_program" value="1">

          <!-- Program Name -->
          <div class="form-group">
            <label class="form-label">Nama Program</label>
            <input type="text" name="name" class="form-control" value="{{ program.name }}" required />
          </div>

          <!-- Total Sessions (Read-only, computed) -->
          <div class="form-group">
            <label class="form-label">Total Sesi</label>
            <div class="d-flex align-items-center gap-2 p-3 rounded" style="background: var(--bg-body);">
              <span class="fw-700 text-brand" style="font-size: 24px;">{{ program.total_sessions }}</span>
              <span class="text-muted">sesi</span>
              <span class="badge badge-secondary ms-2">Computed from Classes</span>
            </div>
            <div class="form-hint">Total sesi dihitung otomatis dari jumlah kelas</div>
          </div>

          <!-- Batch Toggle -->
          <div class="form-group">
            <label class="d-flex align-items-center gap-3 p-3 rounded"
              style="background: var(--bg-body); cursor: pointer;">
              <input class="form-check-input" type="checkbox" name="is_batch_based" style="width: 20px; height: 20px;"
                {% if program.is_batch_based %}checked{% endif %} />
              <div>
                <div class="fw-600">Sistem Batch</div>
                <div class="text-muted" style="font-size: 12px;">Program dengan jadwal tetap</div>
              </div>
            </label>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex gap-2">
            <a href="{{ url_for('admin.program_manage') }}" class="btn btn-secondary flex-fill">
              <i class="fas fa-times me-2"></i> Batal
            </a>
            <button type="submit" class="btn btn-primary flex-fill">
              <i class="fas fa-save me-2"></i> Simpan
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Right Column - Class Management -->
  <div class="col-lg-7">
    <!-- Class List -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-600">
          <i class="fas fa-layer-group me-2 text-brand"></i> Daftar Kelas
        </h5>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addClassModal">
          <i class="fas fa-plus me-1"></i> Tambah Kelas
        </button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table-modern">
            <thead>
              <tr>
                <th class="ps-4">Nama Kelas</th>
                <th class="text-center">Sesi</th>
                <th class="text-center">Jadwal</th>
                <th class="text-center">Max Izin</th>
                <th class="text-center">Tipe</th>
                <th class="text-end pe-4">Aksi</th>
              </tr>
            </thead>
            <tbody>
              {% for cls in program.classes %}
              <tr>
                <td class="ps-4">
                  <div class="fw-600">{{ cls.display_name }}</div>
                  <div class="text-muted" style="font-size: 11px;">Order: {{ cls.order }}</div>
                </td>
                <td class="text-center">
                  <span class="fw-700 text-brand">{{ cls.total_sessions }}</span>
                </td>
                <td class="text-center">
                  {% if cls.is_batch_based %}
                  <span class="text-muted">-</span>
                  {% else %}
                  <span>{{ cls.sessions_per_week }}x / minggu</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if cls.max_izin > 0 %}
                  <span class="badge badge-info">{{ cls.max_izin }}x</span>
                  {% else %}
                  <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if cls.is_batch_based %}
                  <span class="badge badge-warning">Batch</span>
                  {% else %}
                  <span class="badge badge-success">Regular</span>
                  {% endif %}
                </td>
                <td class="text-end pe-4">
                  <form action="{{ url_for('admin.delete_class', class_id=cls.id) }}" method="POST"
                    class="d-inline delete-form" data-confirm="Hapus kelas {{ cls.display_name }}?">
                    <button type="submit" class="btn btn-sm btn-outline text-danger"
                      style="border-color: var(--danger);">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                  <i class="fas fa-layer-group fa-2x mb-2" style="opacity: 0.3;"></i>
                  <p class="mb-0">Belum ada kelas dalam program ini</p>
                  <p class="mb-0" style="font-size: 12px;">Klik "Tambah Kelas" untuk menambahkan</p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% if program.is_batch_based %}
    <!-- Batch Management Section -->
    <div class="card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-600">
          <i class="fas fa-users me-2 text-warning"></i> Daftar Batch
        </h5>
        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#addBatchModal">
          <i class="fas fa-plus me-1"></i> Tambah Batch
        </button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table-modern">
            <thead>
              <tr>
                <th class="ps-4">Nama Batch</th>
                <th class="text-center">Kuota</th>
                <th class="text-center">Status</th>
                <th class="text-end pe-4">Aksi</th>
              </tr>
            </thead>
            <tbody>
              {% for batch in program.batches %}
              <tr>
                <td class="ps-4 fw-600">{{ batch.name }}</td>
                <td class="text-center">{{ batch.max_students }} Siswa</td>
                <td class="text-center">
                  {% if batch.is_active %}
                  <span class="badge badge-success">Aktif</span>
                  {% else %}
                  <span class="badge badge-secondary">Non-Aktif</span>
                  {% endif %}
                </td>
                <td class="text-end pe-4">
                  <form action="{{ url_for('admin.delete_batch', batch_id=batch.id) }}" method="POST"
                    class="d-inline delete-form" data-confirm="Hapus batch ini?">
                    <button type="submit" class="btn btn-sm btn-outline text-danger"
                      style="border-color: var(--danger);">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center py-4 text-muted">Belum ada batch yang dibuat.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Add Class Modal -->
<div class="modal fade" id="addClassModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tambah Kelas ke Program</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{{ url_for('admin.add_class') }}" method="POST">
        <input type="hidden" name="program_id" value="{{ program.id }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Pilih Kelas</label>
            {% if master_classes %}
            <select name="master_class_id" class="form-control" required id="masterClassSelect">
              <option value="">-- Pilih Kelas --</option>
              {% for mc in master_classes %}
              <option value="{{ mc.id }}" data-max-izin="{{ mc.default_max_izin }}">{{ mc.name }}</option>
              {% endfor %}
            </select>
            <div class="form-hint">
              Pilih dari daftar kelas yang sudah dibuat.
              <a href="{{ url_for('admin.master_class_list') }}" class="text-brand">Kelola Master Kelas →</a>
            </div>
            {% else %}
            <div class="alert alert-warning mb-0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Belum ada master kelas.
              <a href="{{ url_for('admin.master_class_list') }}" class="fw-600">Buat kelas baru dulu →</a>
            </div>
            {% endif %}
          </div>
          {% if master_classes %}
          <div class="mb-3">
            <label class="form-label">Jumlah Sesi</label>
            <input type="number" name="total_sessions" class="form-control" value="16" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Jadwal per Minggu</label>
            <select name="sessions_per_week" class="form-control">
              <option value="1">1x per minggu</option>
              <option value="2">2x per minggu</option>
            </select>
            <div class="form-hint">Berapa kali pertemuan per minggu untuk kelas ini</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Max Izin</label>
            <input type="number" name="max_izin" class="form-control" value="0" min="0" id="maxIzinInput">
            <div class="form-hint">Maksimal izin yang diperbolehkan (0 = tidak boleh izin)</div>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="is_batch_based" id="classBatch">
            <label class="form-check-label" for="classBatch">
              Kelas Batch (jadwal ditentukan admin)
            </label>
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          {% if master_classes %}
          <button type="submit" class="btn btn-primary">Tambah Kelas</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Auto-fill max_izin when master class is selected
  document.getElementById('masterClassSelect')?.addEventListener('change', function () {
    const selected = this.options[this.selectedIndex];
    const maxIzin = selected.dataset.maxIzin || 0;
    document.getElementById('maxIzinInput').value = maxIzin;
  });
</script>


{% if program.is_batch_based %}
<!-- Add Batch Modal -->
<div class="modal fade" id="addBatchModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tambah Batch Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{{ url_for('admin.add_batch') }}" method="POST">
        <input type="hidden" name="program_id" value="{{ program.id }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nama Batch</label>
            <input type="text" name="name" class="form-control" placeholder="Contoh: Batch 1" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Kuota Maksimal</label>
            <input type="number" name="max_students" class="form-control" value="6" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">Tambah Batch</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<style>
  .form-group label.d-flex:hover {
    background: var(--border-color) !important;
  }
</style>
{% endblock %}